<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Willhaben Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .auth-container {
            animation: fadeIn 0.5s ease-out;
        }
        
        .logo-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto;
            background-color: var(--primary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .auth-card {
            background-color: transparent;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-foreground);
        }

        .auth-input {
            padding-left: 40px !important;
        }

        .theme-toggle-auth {
            position: fixed;
            top: 1rem;
            right: 1rem;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-background flex items-center justify-center p-4">
        <button id="themeToggle" class="theme-toggle theme-toggle-auth">
            <div id="lightIcon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4"/>
                    <path d="M12 2v2"/>
                    <path d="M12 20v2"/>
                    <path d="m4.93 4.93 1.41 1.41"/>
                    <path d="m17.66 17.66 1.41 1.41"/>
                    <path d="M2 12h2"/>
                    <path d="M20 12h2"/>
                    <path d="m6.34 17.66-1.41 1.41"/>
                    <path d="m19.07 4.93-1.41 1.41"/>
                </svg>
            </div>
            <div id="darkIcon" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                </svg>
            </div>
        </button>

        <div class="container max-w-md auth-container">
            <div class="text-center mb-8">
                <div class="logo-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary-foreground">
                        <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-semibold mb-3">Welcome to Willhaben Monitor</h1>
            </div>

            <div class="auth-card">
                <div class="grid gap-6">
                    <div class="grid gap-3">
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                                </svg>
                            </div>
                            <input type="password" id="apiKey" placeholder="Enter your API key" class="input auth-input" autocomplete="off" spellcheck="false">
                        </div>
                        <p class="text-sm text-muted-foreground">
                            Please contact your administrator if you don't have an API key
                        </p>
                    </div>
                    <button id="saveApiKey" class="btn-primary h-11">
                        Continue to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            const themeToggle = document.getElementById('themeToggle');
            const lightIcon = document.getElementById('lightIcon');
            const darkIcon = document.getElementById('darkIcon');

            // If we already have an API key, redirect to main page
            const savedApiKey = localStorage.getItem('apiKey');
            if (savedApiKey) {
                window.location.href = '/';
                return;
            }

            // Theme management
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            
            function updateTheme(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                lightIcon.style.display = isDark ? 'none' : 'block';
                darkIcon.style.display = isDark ? 'block' : 'none';
            }
            
            // Initialize theme
            if (savedTheme) {
                updateTheme(savedTheme === 'dark');
            } else {
                updateTheme(prefersDark.matches);
            }
            
            // Handle theme toggle click
            themeToggle.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('dark');
                updateTheme(isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            // Handle Enter key in input
            apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveApiKeyBtn.click();
                }
            });

            // Focus input on load
            apiKeyInput.focus();

            saveApiKeyBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showError('Please enter your API key');
                    apiKeyInput.focus();
                    return;
                }

                // Update button state
                const originalText = saveApiKeyBtn.textContent;
                saveApiKeyBtn.disabled = true;
                saveApiKeyBtn.innerHTML = `
                    <svg class="animate-spin mr-2 inline" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                    </svg>
                    Verifying...
                `;

                try {
                    // Test the API key with a simple request
                    const response = await fetch('/api/getMonitoringStatus', {
                        headers: {
                            'X-API-Key': apiKey
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            throw new Error('Invalid API key. Please check and try again.');
                        }
                        throw new Error('Failed to validate API key. Please try again.');
                    }

                    // Show success animation before redirect
                    saveApiKeyBtn.innerHTML = `
                        <svg class="mr-2 inline" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        Success! Redirecting...
                    `;

                    // If we get here, the API key is valid
                    localStorage.setItem('apiKey', apiKey);
                    
                    // Redirect after a short delay to show success state
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } catch (error) {
                    showError(error.message);
                    saveApiKeyBtn.disabled = false;
                    saveApiKeyBtn.textContent = originalText;
                    apiKeyInput.focus();
                }
            });

            function showError(message) {
                // Remove any existing error message
                const existingError = document.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.style.animation = 'fadeIn 0.3s ease-out';
                errorMessage.innerHTML = `
                    <div class="flex items-center gap-2 text-destructive mt-4 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 8v4M12 16h.01"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
                document.querySelector('.auth-card').appendChild(errorMessage);

                // Shake animation for input
                apiKeyInput.style.animation = 'none';
                apiKeyInput.offsetHeight; // Trigger reflow
                apiKeyInput.style.animation = 'shake 0.5s ease-in-out';
            }
        });
    </script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-4px); }
            40% { transform: translateX(4px); }
            60% { transform: translateX(-2px); }
            80% { transform: translateX(2px); }
        }
    </style>
</body>
</html>